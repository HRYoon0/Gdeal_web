"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[156],{283:(e,t,o)=>{o.d(t,{A:()=>c,AuthProvider:()=>u});var r=o(5155),l=o(2115),n=o(5404),a=o(6104),i=o(9086);let s=(0,l.createContext)({user:null,userProfile:null,loading:!0,profileLoading:!1,signIn:async()=>{},signUp:async()=>{},logout:async()=>{},resetPassword:async()=>{},updateUserProfile:async()=>{},updateEmailConsent:async()=>{},refreshUserProfile:async()=>{}}),c=()=>(0,l.useContext)(s);function u(e){let{children:t}=e,[c,u]=(0,l.useState)(null),[g,f]=(0,l.useState)(null),[d,h]=(0,l.useState)(!0),[y,p]=(0,l.useState)(!1),[w,m]=(0,l.useState)(!1),[v,b]=(0,l.useState)(!1);(0,l.useEffect)(()=>{console.log("\uD83D\uDD25 AuthContext useEffect 시작");let e=setTimeout(()=>{console.log("⚠️ 5초 후에도 로딩 중 - 강제 로딩 해제"),h(!1)},5e3),t=(0,n.hg)(a.j,async t=>{if(console.log("\uD83D\uDD04 onAuthStateChanged 실행:",null==t?void 0:t.uid),clearTimeout(e),w||v)return void console.log("⏸️ 회원가입/로그인 과정 중이므로 onAuthStateChanged 무시");if(t){console.log("\uD83D\uDC64 사용자 감지됨:",t.uid),p(!0),u(t);try{console.log("\uD83D\uDCCB getUserProfile 호출 시작");let e=await (0,i.VM)(t.uid);console.log("\uD83D\uDCCB getUserProfile 결과:",e),e&&"approved"===e.status?(f(e),console.log("✅ 승인된 사용자 프로필 설정 완료")):e&&"approved"!==e.status?(console.log("❌ 승인되지 않은 사용자 - 로그아웃 처리"),u(null),f(null),await (0,n.CI)(a.j)):(console.log("⚠️ 프로필 없음 - user 상태는 유지, userProfile은 null"),f(null))}catch(e){console.error("\uD83D\uDCA5 onAuthStateChanged 에러:",e),console.log("\uD83D\uDD27 에러 발생했지만 user 상태는 유지"),f(null),console.log("\uD83D\uDD0D 에러 상세:",e instanceof Error?e.message:String(e))}finally{p(!1)}}else console.log("\uD83D\uDEAA 로그아웃 상태"),u(null),f(null),p(!1);console.log("\uD83C\uDFC1 AuthContext 처리 완료 - 로딩 해제"),h(!1)});return()=>{clearTimeout(e),t()}},[w,v]);let P=async(e,t)=>{try{b(!0),console.log("로그인 시도 시작");let o=(await (0,n.x9)(a.j,e,t)).user;console.log("Firebase 인증 성공, UID:",o.uid),console.log("사용자 상태 확인 시작");let r=null,l=null,s=!1;try{if(console.log("getUserProfile 호출 시작"),r=await (0,i.VM)(o.uid),console.log("getUserProfile 성공, 결과:",r),r&&"approved"===r.status){console.log("승인된 사용자 로그인 성공"),u(o),f(r),b(!1);return}}catch(e){console.error("getUserProfile 에러 (무시하고 계속):",e),s=!0}if(!r)try{console.log("getPendingUser 호출 시작"),l=await (0,i.bN)(o.uid),console.log("getPendingUser 성공, 결과:",l)}catch(e){console.error("getPendingUser 에러 (무시하고 계속):",e),s=!0}if(console.log("❌ 승인되지 않은 사용자, 로그아웃 처리"),await (0,n.CI)(a.j),b(!1),r)if("pending"===r.status)throw Error("승인 대기 중입니다. 관리자 승인 후 로그인할 수 있습니다.");else if("rejected"===r.status)throw Error("회원가입이 승인되지 않았습니다. 관리자에게 문의해주세요.");else throw Error("알 수 없는 사용자 상태입니다. 관리자에게 문의해주세요.");if(l)throw Error("승인 대기 중입니다. 관리자 승인 후 로그인할 수 있습니다.");if(s)throw Error("로그인 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.");else throw Error("등록되지 않은 계정입니다. 회원가입을 진행해주세요.")}catch(e){throw console.error("signIn 에러:",e),b(!1),e}},j=async(e,t,o,r,l)=>{try{m(!0);let s=!1;try{let{user:c}=await (0,n.eJ)(a.j,e,t);await (0,n.r7)(c,{displayName:o}),await (0,i.EE)({uid:c.uid,email:c.email,displayName:o,school:r,authProvider:"email",emailConsent:(null==l?void 0:l.optional)||null,consentDate:(null==l?void 0:l.optional)?new Date:null}),console.log("✅ 회원가입 성공 - pending user 생성 완료"),s=!0}catch(c){if(c instanceof Error&&"code"in c&&"auth/email-already-in-use"===c.code){console.log("\uD83D\uDD04 Firebase Auth 사용자는 존재하지만 Firestore 데이터 확인 중...");let{user:c}=await (0,n.x9)(a.j,e,t);console.log("\uD83D\uDD0D 기존 사용자 UID:",c.uid);let u=await (0,i.VM)(c.uid),g=await (0,i.bN)(c.uid);if(u||g)throw console.log("❌ 이미 등록된 사용자 - 기존 데이터 존재"),m(!1),await (0,n.CI)(a.j).catch(e=>console.error("로그아웃 에러:",e)),Error("이미 등록된 계정입니다.");console.log("✅ Firestore 데이터 없음 - 새로 생성"),await (0,n.r7)(c,{displayName:o}),await (0,i.EE)({uid:c.uid,email:c.email,displayName:o,school:r,authProvider:"email",emailConsent:(null==l?void 0:l.optional)||null,consentDate:(null==l?void 0:l.optional)?new Date:null}),console.log("✅ 새로운 pending user 생성 완료"),s=!0}else throw m(!1),c}if(s){m(!1);try{await (0,n.CI)(a.j),console.log("✅ 회원가입 후 로그아웃 완료")}catch(e){console.error("⚠️ 로그아웃 에러 (무시):",e)}}}catch(e){throw m(!1),e}},E=async()=>{try{await (0,n.CI)(a.j),u(null),f(null),console.log("로그아웃 완료")}catch(e){throw console.error("로그아웃 에러:",e),e}},O=async e=>{try{await (0,n.J1)(a.j,e)}catch(e){throw e}},C=async()=>{if(c)try{p(!0),console.log("\uD83D\uDD04 강제로 userProfile 새로고침 시도");let e=await (0,i.VM)(c.uid);console.log("\uD83D\uDD04 강제 새로고침 결과:",e),e&&"approved"===e.status?(f(e),console.log("✅ userProfile 새로고침 성공")):(console.log("❌ 승인되지 않은 사용자 또는 프로필 없음"),f(null))}catch(e){console.error("❌ userProfile 새로고침 실패:",e)}finally{p(!1)}},S=async e=>{try{if(!c||!g)throw Error("사용자 정보가 없습니다.");e.displayName&&await (0,n.r7)(c,{displayName:e.displayName});let{updateDoc:t,doc:r}=await Promise.resolve().then(o.bind(o,5317)),{db:l}=await Promise.resolve().then(o.bind(o,6104)),a=r(l,"users",c.uid);await t(a,e),f(t=>t?{...t,...e}:null)}catch(e){throw e}},x=async e=>{try{if(!c)throw Error("사용자 정보가 없습니다.");console.log("\uD83D\uDD04 AuthContext updateEmailConsent 호출:",{사용자:c.uid,새로운_동의_상태:e}),await (0,i.ih)(c.uid,e),f(t=>t?{...t,emailConsent:!!e||null,consentDate:e?new Date:null}:null),console.log("✅ AuthContext updateEmailConsent 완료")}catch(e){throw console.error("❌ AuthContext updateEmailConsent 실패:",e),e}};return(0,r.jsx)(s.Provider,{value:{user:c,userProfile:g,loading:d,profileLoading:y,signIn:P,signUp:j,logout:E,resetPassword:O,updateUserProfile:S,updateEmailConsent:x,refreshUserProfile:C},children:t})}},4436:(e,t,o)=>{o.d(t,{k5:()=>u});var r=o(2115),l={color:void 0,size:void 0,className:void 0,style:void 0,attr:void 0},n=r.createContext&&r.createContext(l),a=["attr","size","title"];function i(){return(i=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(e[r]=o[r])}return e}).apply(this,arguments)}function s(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),o.push.apply(o,r)}return o}function c(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?s(Object(o),!0).forEach(function(t){var r,l,n;r=e,l=t,n=o[t],(l=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var r=o.call(e,t||"default");if("object"!=typeof r)return r;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(l))in r?Object.defineProperty(r,l,{value:n,enumerable:!0,configurable:!0,writable:!0}):r[l]=n}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):s(Object(o)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))})}return e}function u(e){return t=>r.createElement(g,i({attr:c({},e.attr)},t),function e(t){return t&&t.map((t,o)=>r.createElement(t.tag,c({key:o},t.attr),e(t.child)))}(e.child))}function g(e){var t=t=>{var o,{attr:l,size:n,title:s}=e,u=function(e,t){if(null==e)return{};var o,r,l=function(e,t){if(null==e)return{};var o={};for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){if(t.indexOf(r)>=0)continue;o[r]=e[r]}return o}(e,t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);for(r=0;r<n.length;r++)o=n[r],!(t.indexOf(o)>=0)&&Object.prototype.propertyIsEnumerable.call(e,o)&&(l[o]=e[o])}return l}(e,a),g=n||t.size||"1em";return t.className&&(o=t.className),e.className&&(o=(o?o+" ":"")+e.className),r.createElement("svg",i({stroke:"currentColor",fill:"currentColor",strokeWidth:"0"},t.attr,l,u,{className:o,style:c(c({color:e.color||t.color},t.style),e.style),height:g,width:g,xmlns:"http://www.w3.org/2000/svg"}),s&&r.createElement("title",null,s),e.children)};return void 0!==n?r.createElement(n.Consumer,null,e=>t(e)):t(l)}},6681:(e,t,o)=>{o.d(t,{A:()=>l});var r=o(283);let l=()=>{let e=(0,r.A)();if(!e)throw Error("useAuth must be used within an AuthProvider");return e}}}]);