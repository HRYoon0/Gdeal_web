"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[86],{6104:(e,t,a)=>{a.d(t,{db:()=>s,j:()=>l});var o=a(3915),r=a(5404),n=a(5317);let d={apiKey:"AIzaSyBJsqUJK1AjhrLNzIY_79dIR2Mlg7zD09w",authDomain:"gdeal-page-a67e2.firebaseapp.com",projectId:"gdeal-page-a67e2",storageBucket:"gdeal-page-a67e2.firebasestorage.app",messagingSenderId:"654155447220",appId:"1:654155447220:web:be9c45c91314842d0150e1"};for(let e of["apiKey","authDomain","projectId","storageBucket","messagingSenderId","appId"])if(!d[e])throw Error("\uD83D\uDD25 Firebase 설정값이 누락되었습니다: ".concat(e,". 환경변수 설정을 확인해주세요."));let i=0===(0,o.Dk)().length?(0,o.Wp)(d):(0,o.Dk)()[0],l=(0,r.xI)(i),s=(0,n.aU)(i)},9086:(e,t,a)=>{a.d(t,{$D:()=>_,A:()=>D,BR:()=>f,EE:()=>u,Ef:()=>R,Hq:()=>E,Jx:()=>k,K7:()=>N,MJ:()=>w,SX:()=>b,Uy:()=>p,VG:()=>S,VM:()=>i,Vz:()=>d,WT:()=>x,Wt:()=>c,X:()=>V,Xj:()=>O,Yk:()=>A,ZV:()=>P,aw:()=>J,bN:()=>g,c0:()=>T,ih:()=>j,kO:()=>G,kQ:()=>v,lf:()=>y,lh:()=>h,mn:()=>s,nQ:()=>B,qM:()=>I,qQ:()=>M,qm:()=>U,v_:()=>l,wx:()=>C});var o=a(5317),r=a(6104);let n={USERS:"users",PENDING_USERS:"pendingUsers",ADMIN_ACTIONS:"adminActions",EVENTS:"events",TRAININGS:"trainings",DIARIES:"diaries",VISITOR_STATS:"visitorStats"},d=async e=>{let t=(0,o.doc)(r.db,n.USERS,e.uid);await (0,o.BN)(t,{...e,createdAt:o.Dc.now(),emailConsent:void 0!==e.emailConsent?e.emailConsent:null})},i=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;for(let c=1;c<=t;c++)try{console.log("getUserProfile 시도 ".concat(c,"/").concat(t," for uid:"),e);let u=(0,o.doc)(r.db,n.USERS,e),p=await (0,o.x7)(u);if(p.exists()){var a,d,i,l,s;let t=p.data();console.log("getUserProfile 성공, 원본 데이터:",t);let o=t.role||"user",r=t.memberTier||("superAdmin"===o||"admin"===o?"operations-office":"sharing-member"),n={uid:t.uid||e,email:t.email||"",displayName:t.displayName||t.email||"익명",school:t.school||"",status:t.status||"approved",role:o,memberTier:r,createdAt:(null==(a=t.createdAt)?void 0:a.toDate())||new Date,approvedAt:null==(d=t.approvedAt)?void 0:d.toDate(),approvedBy:t.approvedBy,tierChangedAt:(null==(i=t.tierChangedAt)?void 0:i.toDate())||(null==(l=t.createdAt)?void 0:l.toDate())||new Date,tierChangedBy:t.tierChangedBy||t.approvedBy||"system",emailConsent:t.emailConsent,consentDate:null==(s=t.consentDate)?void 0:s.toDate()};return console.log("getUserProfile 결과 (기본값 적용 후):",n),console.log("\uD83D\uDD0D 중요 필드 확인 - role:",n.role,"memberTier:",n.memberTier),console.log("\uD83D\uDCE7 이메일 동의 필드 확인 - emailConsent:",n.emailConsent,"consentDate:",n.consentDate),console.log("\uD83D\uDCCB 전체 결과 JSON:",JSON.stringify(n,null,2)),n}console.log("getUserProfile: 문서가 존재하지 않음");break}catch(e){if(console.error("getUserProfile 시도 ".concat(c," 실패:"),e),c===t)throw console.error("getUserProfile 최종 실패, 모든 재시도 완료"),e;await new Promise(e=>setTimeout(e,1e3*c))}return null},l=async function(e,t){let a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],d=(0,o.doc)(r.db,n.USERS,e);a?await (0,o.updateDoc)(d,{role:t,approvedAt:o.Dc.now()}):await (0,o.updateDoc)(d,{role:t})},s=async(e,t,a,d)=>{let i=(0,o.doc)(r.db,n.USERS,e),l=await (0,o.x7)(i);if(!l.exists())throw Error("사용자를 찾을 수 없습니다.");let s=l.data();if(!await m(a))throw Error("등급 변경 권한이 없습니다.");await (0,o.updateDoc)(i,{memberTier:t,tierChangedAt:o.Dc.now(),tierChangedBy:a}),await A({adminId:a,action:"change-tier",targetUserId:e,reason:d,fromTier:s.memberTier,toTier:t})},c=async e=>{let t=(0,o.doc)(r.db,n.USERS,e);await (0,o.kd)(t)},u=async e=>{let t={...e,status:"pending",createdAt:o.Dc.now(),emailConsent:void 0!==e.emailConsent?e.emailConsent:null},a=(0,o.doc)(r.db,n.PENDING_USERS,e.uid);await (0,o.BN)(a,t)},p=async e=>{let t=(0,o.doc)(r.db,n.PENDING_USERS,e);await (0,o.kd)(t)},g=async e=>{let t=(0,o.doc)(r.db,n.PENDING_USERS,e),a=await (0,o.x7)(t);if(a.exists()){let e=a.data();if(!e.status||"processed"!==e.status)return{...e,createdAt:e.createdAt.toDate()}}return null},D=async()=>(await (0,o.GG)((0,o.rJ)(r.db,n.PENDING_USERS))).docs.map(e=>{let t=e.data();return{...t,createdAt:t.createdAt.toDate()}}).filter(e=>!e.status||"processed"!==e.status),m=async e=>{let t=await i(e);return(null==t?void 0:t.role)==="admin"||(null==t?void 0:t.role)==="superAdmin"},w=async()=>{let e=(0,o.P)((0,o.rJ)(r.db,n.USERS),(0,o._M)("status","==","approved"));return(await (0,o.GG)(e)).docs.map(e=>{var t,a,o;let r=e.data();return{...r,createdAt:r.createdAt.toDate(),approvedAt:null==(t=r.approvedAt)?void 0:t.toDate(),memberTier:r.memberTier||("superAdmin"===r.role||"admin"===r.role?"operations-office":"learning-member"),tierChangedAt:(null==(a=r.tierChangedAt)?void 0:a.toDate())||(null==(o=r.createdAt)?void 0:o.toDate())||new Date,tierChangedBy:r.tierChangedBy||r.approvedBy||"system"}})},A=async e=>{let t={};for(let[a,o]of Object.entries(e))void 0!==o&&(t[a]=o);await (0,o.gS)((0,o.rJ)(r.db,n.ADMIN_ACTIONS),{...t,timestamp:o.Dc.now()})},y=async(e,t)=>{let a={successful:0,failed:[]};for(let o of e)try{await d({uid:o.uid,email:o.email,displayName:o.displayName,school:o.school,status:"approved",role:"user",memberTier:"learning-member",approvedBy:t,approvedAt:new Date,tierChangedAt:new Date,tierChangedBy:t,emailConsent:o.emailConsent,consentDate:o.consentDate}),await p(o.uid),await A({adminId:t,action:"approve",targetUserId:o.uid}),a.successful++}catch(e){console.error("Failed to approve user ".concat(o.displayName,":"),e),a.failed.push({user:o,error:e instanceof Error?e.message:"알 수 없는 오류"})}return a},S=async(e,t,a,o)=>{let r={uid:e,email:t,displayName:a,school:o,status:"approved",role:"superAdmin",memberTier:"operations-office",approvedAt:new Date,approvedBy:e,tierChangedAt:new Date,tierChangedBy:e};await d(r)},h=async e=>(await (0,o.gS)((0,o.rJ)(r.db,n.EVENTS),{...e,createdAt:o.Dc.now(),updatedAt:o.Dc.now()})).id,v=async()=>{let e=(0,o.P)((0,o.rJ)(r.db,n.EVENTS),(0,o.My)("date","desc"));return(await (0,o.GG)(e)).docs.map(e=>{var t,a;return{id:e.id,...e.data(),createdAt:null==(t=e.data().createdAt)?void 0:t.toDate(),updatedAt:null==(a=e.data().updatedAt)?void 0:a.toDate()}})},I=async(e,t)=>{let a=(0,o.doc)(r.db,n.EVENTS,e);await (0,o.updateDoc)(a,{...t,updatedAt:o.Dc.now()})},b=async e=>{let t=(0,o.doc)(r.db,n.EVENTS,e);await (0,o.kd)(t)},E=async e=>{let t=(0,o.doc)(r.db,n.USERS,e);(await (0,o.x7)(t)).exists()&&await (0,o.kd)(t);let a=(0,o.doc)(r.db,n.PENDING_USERS,e);(await (0,o.x7)(a)).exists()&&await (0,o.kd)(a)},f=async e=>{let t={};for(let[a,o]of Object.entries(e))void 0!==o&&(t[a]=o);return(await (0,o.gS)((0,o.rJ)(r.db,n.TRAININGS),{...t,createdAt:o.Dc.now(),updatedAt:o.Dc.now()})).id},T=async()=>{let e=(0,o.P)((0,o.rJ)(r.db,n.TRAININGS),(0,o.My)("date","asc"));return(await (0,o.GG)(e)).docs.map(e=>{var t,a;return{id:e.id,...e.data(),createdAt:null==(t=e.data().createdAt)?void 0:t.toDate(),updatedAt:null==(a=e.data().updatedAt)?void 0:a.toDate()}})},N=async(e,t)=>{try{console.log("updateTraining 함수 시작 - trainingId:",e),console.log("updateTraining - 받은 데이터:",t);let a={};for(let[e,o]of Object.entries(t))void 0!==o&&(a[e]=o);console.log("updateTraining - 정리된 데이터:",a);let d=(0,o.doc)(r.db,n.TRAININGS,e),i={...a,updatedAt:o.Dc.now()};console.log("updateTraining - 최종 업데이트 페이로드:",i),await (0,o.updateDoc)(d,i),console.log("updateTraining - Firestore 업데이트 성공")}catch(e){throw console.error("updateTraining 함수 오류:",e),e}},C=async e=>{let t=(0,o.doc)(r.db,n.TRAININGS,e);await (0,o.kd)(t)},R=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5,t=new Date().toISOString().split("T")[0],a=(0,o.P)((0,o.rJ)(r.db,n.TRAININGS),(0,o._M)("date",">=",t),(0,o.My)("date","asc"));return(await (0,o.GG)(a)).docs.map(e=>{var t,a;return{id:e.id,...e.data(),createdAt:null==(t=e.data().createdAt)?void 0:t.toDate(),updatedAt:null==(a=e.data().updatedAt)?void 0:a.toDate()}}).slice(0,e)},U=async e=>{try{console.log("createDiaryEntry 함수 시작"),console.log("저장할 일기 데이터:",e);let t={...e,createdAt:o.Dc.now(),updatedAt:o.Dc.now()};console.log("Firestore에 저장할 최종 데이터:",t);let a=await (0,o.gS)((0,o.rJ)(r.db,n.DIARIES),t);return console.log("일기 저장 성공 - 문서 ID:",a.id),a.id}catch(e){throw console.error("createDiaryEntry 함수 오류:",e),e}},G=async e=>{try{let t;console.log("getDiaryEntries 함수 시작 - authorId:",e),e?(console.log("특정 사용자 일기 조회 - authorId:",e),t=(0,o.P)((0,o.rJ)(r.db,n.DIARIES),(0,o._M)("authorId","==",e),(0,o.My)("date","desc"))):(console.log("모든 일기 조회 (관리자용)"),t=(0,o.P)((0,o.rJ)(r.db,n.DIARIES),(0,o.My)("date","desc"))),console.log("Firestore 쿼리 실행 중...");let a=await (0,o.GG)(t);console.log("Firestore 쿼리 완료 - 문서 개수:",a.docs.length);let d=a.docs.map(e=>{var t,a;let o=e.data();return console.log("일기 문서:",e.id,"- authorId:",o.authorId,"- 제목:",o.title),{id:e.id,...o,createdAt:null==(t=o.createdAt)?void 0:t.toDate(),updatedAt:null==(a=o.updatedAt)?void 0:a.toDate()}});return console.log("getDiaryEntries 완료 - 반환할 일기 개수:",d.length),d}catch(e){throw console.error("getDiaryEntries 함수 오류:",e),e}},_=async(e,t)=>{let a=(0,o.doc)(r.db,n.DIARIES,e);await (0,o.updateDoc)(a,{...t,updatedAt:o.Dc.now()})},B=async e=>{let t=(0,o.doc)(r.db,n.DIARIES,e);await (0,o.kd)(t)},P=async(e,t)=>{try{let a;console.log("좋아요 토글 시작 - diaryId:",e,"userId:",t);let d=(0,o.doc)(r.db,n.DIARIES,e),i=await (0,o.x7)(d);if(!i.exists())throw Error("일기를 찾을 수 없습니다.");let l=i.data().likes||[],s=l.includes(t);return a=s?l.filter(e=>e!==t):[...l,t],await (0,o.updateDoc)(d,{likes:a,updatedAt:o.Dc.now()}),console.log("좋아요 토글 완료 - 새로운 상태:",!s,"좋아요 수:",a.length),{liked:!s,likesCount:a.length}}catch(e){throw console.error("좋아요 토글 실패:",e),e}},k=async()=>{try{let e=new Date().toISOString().split("T")[0],t=(0,o.doc)(r.db,n.VISITOR_STATS,e),a=(0,o.doc)(r.db,n.VISITOR_STATS,"total"),[d,i]=await Promise.all([(0,o.x7)(t),(0,o.x7)(a)]),l=d.exists()?d.data().count:0,s=i.exists()?i.data().totalVisits:0;await (0,o.BN)(t,{date:e,count:l+1,lastUpdated:o.Dc.now()}),await (0,o.BN)(a,{totalVisits:s+1,todayVisits:l+1,lastUpdated:o.Dc.now()})}catch(e){console.error("방문자 수 기록 실패:",e)}},x=async()=>{try{let e=new Date().toISOString().split("T")[0],t=(0,o.doc)(r.db,n.VISITOR_STATS,"total"),a=(0,o.doc)(r.db,n.VISITOR_STATS,e),[d,i]=await Promise.all([(0,o.x7)(t),(0,o.x7)(a)]),l=d.exists()?d.data().totalVisits:0,s=i.exists()?i.data().count:0;return{totalVisits:l,todayVisits:s,lastUpdated:new Date}}catch(e){return console.error("방문자 통계 조회 실패:",e),{totalVisits:0,todayVisits:0,lastUpdated:new Date}}},V=async()=>{try{console.log("이메일 수신 동의 사용자 조회 시작");let e=(0,o.P)((0,o.rJ)(r.db,n.USERS),(0,o._M)("status","==","approved"),(0,o._M)("emailConsent","==",!0)),t=await (0,o.GG)(e);return console.log("이메일 동의 사용자 문서 개수:",t.docs.length),t.docs.map(e=>{var t,a,o,r;let n=e.data();return{...n,createdAt:n.createdAt.toDate(),approvedAt:null==(t=n.approvedAt)?void 0:t.toDate(),consentDate:null==(a=n.consentDate)?void 0:a.toDate(),tierChangedAt:(null==(o=n.tierChangedAt)?void 0:o.toDate())||(null==(r=n.createdAt)?void 0:r.toDate())||new Date,memberTier:n.memberTier||("superAdmin"===n.role||"admin"===n.role?"operations-office":"learning-member"),tierChangedBy:n.tierChangedBy||n.approvedBy||"system"}})}catch(e){throw console.error("이메일 수신 동의 사용자 조회 실패:",e),e}},J=async()=>{try{console.log("대기 중인 이메일 수신 동의 사용자 조회 시작");let e=(0,o.P)((0,o.rJ)(r.db,n.PENDING_USERS),(0,o._M)("emailConsent","==",!0)),t=await (0,o.GG)(e);return console.log("대기 중인 이메일 동의 사용자 문서 개수:",t.docs.length),t.docs.map(e=>{var t;let a=e.data();return{...a,createdAt:a.createdAt.toDate(),consentDate:null==(t=a.consentDate)?void 0:t.toDate()}}).filter(e=>!e.status||"processed"!==e.status)}catch(e){throw console.error("대기 중인 이메일 수신 동의 사용자 조회 실패:",e),e}},M=async()=>{try{console.log("모든 사용자 이메일 동의 상태 조회 시작");let e=(0,o.P)((0,o.rJ)(r.db,n.USERS),(0,o._M)("status","==","approved")),t=await (0,o.GG)(e);return console.log("전체 승인된 사용자 문서 개수:",t.docs.length),t.docs.map(e=>{var t,a,o,r;let n=e.data();return{...n,createdAt:n.createdAt.toDate(),approvedAt:null==(t=n.approvedAt)?void 0:t.toDate(),consentDate:null==(a=n.consentDate)?void 0:a.toDate(),tierChangedAt:(null==(o=n.tierChangedAt)?void 0:o.toDate())||(null==(r=n.createdAt)?void 0:r.toDate())||new Date,memberTier:n.memberTier||("superAdmin"===n.role||"admin"===n.role?"operations-office":"learning-member"),tierChangedBy:n.tierChangedBy||n.approvedBy||"system",emailConsent:n.emailConsent}})}catch(e){throw console.error("모든 사용자 이메일 동의 상태 조회 실패:",e),e}},O=async(e,t,a)=>{try{console.log("사용자 이메일 동의 상태 업데이트 시작:",{userId:e,emailConsent:t,adminUserId:a});let d=(0,o.doc)(r.db,n.USERS,e),i={emailConsent:t,consentDate:t?new Date:null};await (0,o.updateDoc)(d,i),await A({adminId:a,action:"update_email_consent",targetUserId:e,reason:"이메일 동의 상태를 ".concat(t?"동의":"미동의","로 변경")}),console.log("✅ 사용자 이메일 동의 상태 업데이트 성공")}catch(e){throw console.error("❌ 사용자 이메일 동의 상태 업데이트 실패:",e),e}},j=async(e,t)=>{try{console.log("개인 이메일 동의 상태 업데이트 시작:",{userId:e,emailConsent:t});let a=(0,o.doc)(r.db,n.USERS,e),d={emailConsent:!!t||null,consentDate:t?o.Dc.now():null};console.log("\uD83D\uDD04 Firestore 업데이트 데이터:",d),await (0,o.updateDoc)(a,d),console.log("✅ 개인 이메일 동의 상태 업데이트 성공")}catch(e){throw console.error("❌ 개인 이메일 동의 상태 업데이트 실패:",e),e}}}}]);