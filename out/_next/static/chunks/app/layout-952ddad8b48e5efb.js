(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[177],{283:(e,o,l)=>{"use strict";l.d(o,{A:()=>c,AuthProvider:()=>u});var t=l(5155),n=l(2115),r=l(5404),a=l(6104),s=l(9086);let i=(0,n.createContext)({user:null,userProfile:null,loading:!0,profileLoading:!1,signIn:async()=>{},signUp:async()=>{},logout:async()=>{},resetPassword:async()=>{},updateUserProfile:async()=>{},updateEmailConsent:async()=>{},refreshUserProfile:async()=>{}}),c=()=>(0,n.useContext)(i);function u(e){let{children:o}=e,[c,u]=(0,n.useState)(null),[g,d]=(0,n.useState)(null),[h,w]=(0,n.useState)(!0),[f,y]=(0,n.useState)(!1),[m,p]=(0,n.useState)(!1),[P,C]=(0,n.useState)(!1);(0,n.useEffect)(()=>{console.log("\uD83D\uDD25 AuthContext useEffect 시작");let e=setTimeout(()=>{console.log("⚠️ 5초 후에도 로딩 중 - 강제 로딩 해제"),w(!1)},5e3),o=(0,r.hg)(a.j,async o=>{if(console.log("\uD83D\uDD04 onAuthStateChanged 실행:",null==o?void 0:o.uid),clearTimeout(e),m||P)return void console.log("⏸️ 회원가입/로그인 과정 중이므로 onAuthStateChanged 무시");if(o){console.log("\uD83D\uDC64 사용자 감지됨:",o.uid),y(!0),u(o);try{console.log("\uD83D\uDCCB getUserProfile 호출 시작");let e=await (0,s.VM)(o.uid);console.log("\uD83D\uDCCB getUserProfile 결과:",e),e&&"approved"===e.status?(d(e),console.log("✅ 승인된 사용자 프로필 설정 완료")):e&&"approved"!==e.status?(console.log("❌ 승인되지 않은 사용자 - 로그아웃 처리"),u(null),d(null),await (0,r.CI)(a.j)):(console.log("⚠️ 프로필 없음 - user 상태는 유지, userProfile은 null"),d(null))}catch(e){console.error("\uD83D\uDCA5 onAuthStateChanged 에러:",e),console.log("\uD83D\uDD27 에러 발생했지만 user 상태는 유지"),d(null),console.log("\uD83D\uDD0D 에러 상세:",e instanceof Error?e.message:String(e))}finally{y(!1)}}else console.log("\uD83D\uDEAA 로그아웃 상태"),u(null),d(null),y(!1);console.log("\uD83C\uDFC1 AuthContext 처리 완료 - 로딩 해제"),w(!1)});return()=>{clearTimeout(e),o()}},[m,P]);let E=async(e,o)=>{try{C(!0),console.log("로그인 시도 시작");let l=(await (0,r.x9)(a.j,e,o)).user;console.log("Firebase 인증 성공, UID:",l.uid),console.log("사용자 상태 확인 시작");let t=null,n=null,i=!1;try{if(console.log("getUserProfile 호출 시작"),t=await (0,s.VM)(l.uid),console.log("getUserProfile 성공, 결과:",t),t&&"approved"===t.status){console.log("승인된 사용자 로그인 성공"),u(l),d(t),C(!1);return}}catch(e){console.error("getUserProfile 에러 (무시하고 계속):",e),i=!0}if(!t)try{console.log("getPendingUser 호출 시작"),n=await (0,s.bN)(l.uid),console.log("getPendingUser 성공, 결과:",n)}catch(e){console.error("getPendingUser 에러 (무시하고 계속):",e),i=!0}if(console.log("❌ 승인되지 않은 사용자, 로그아웃 처리"),await (0,r.CI)(a.j),C(!1),t)if("pending"===t.status)throw Error("승인 대기 중입니다. 관리자 승인 후 로그인할 수 있습니다.");else if("rejected"===t.status)throw Error("회원가입이 승인되지 않았습니다. 관리자에게 문의해주세요.");else throw Error("알 수 없는 사용자 상태입니다. 관리자에게 문의해주세요.");if(n)throw Error("승인 대기 중입니다. 관리자 승인 후 로그인할 수 있습니다.");if(i)throw Error("로그인 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.");else throw Error("등록되지 않은 계정입니다. 회원가입을 진행해주세요.")}catch(e){throw console.error("signIn 에러:",e),C(!1),e}},v=async(e,o,l,t,n)=>{try{p(!0);let i=!1;try{let{user:c}=await (0,r.eJ)(a.j,e,o);await (0,r.r7)(c,{displayName:l}),await (0,s.EE)({uid:c.uid,email:c.email,displayName:l,school:t,authProvider:"email",emailConsent:(null==n?void 0:n.optional)||null,consentDate:(null==n?void 0:n.optional)?new Date:null}),console.log("✅ 회원가입 성공 - pending user 생성 완료"),i=!0}catch(c){if(c instanceof Error&&"code"in c&&"auth/email-already-in-use"===c.code){console.log("\uD83D\uDD04 Firebase Auth 사용자는 존재하지만 Firestore 데이터 확인 중...");let{user:c}=await (0,r.x9)(a.j,e,o);console.log("\uD83D\uDD0D 기존 사용자 UID:",c.uid);let u=await (0,s.VM)(c.uid),g=await (0,s.bN)(c.uid);if(u||g)throw console.log("❌ 이미 등록된 사용자 - 기존 데이터 존재"),p(!1),await (0,r.CI)(a.j).catch(e=>console.error("로그아웃 에러:",e)),Error("이미 등록된 계정입니다.");console.log("✅ Firestore 데이터 없음 - 새로 생성"),await (0,r.r7)(c,{displayName:l}),await (0,s.EE)({uid:c.uid,email:c.email,displayName:l,school:t,authProvider:"email",emailConsent:(null==n?void 0:n.optional)||null,consentDate:(null==n?void 0:n.optional)?new Date:null}),console.log("✅ 새로운 pending user 생성 완료"),i=!0}else throw p(!1),c}if(i){p(!1);try{await (0,r.CI)(a.j),console.log("✅ 회원가입 후 로그아웃 완료")}catch(e){console.error("⚠️ 로그아웃 에러 (무시):",e)}}}catch(e){throw p(!1),e}},b=async()=>{try{await (0,r.CI)(a.j),u(null),d(null),console.log("로그아웃 완료")}catch(e){throw console.error("로그아웃 에러:",e),e}},_=async e=>{try{await (0,r.J1)(a.j,e)}catch(e){throw e}},U=async()=>{if(c)try{y(!0),console.log("\uD83D\uDD04 강제로 userProfile 새로고침 시도");let e=await (0,s.VM)(c.uid);console.log("\uD83D\uDD04 강제 새로고침 결과:",e),e&&"approved"===e.status?(d(e),console.log("✅ userProfile 새로고침 성공")):(console.log("❌ 승인되지 않은 사용자 또는 프로필 없음"),d(null))}catch(e){console.error("❌ userProfile 새로고침 실패:",e)}finally{y(!1)}},j=async e=>{try{if(!c||!g)throw Error("사용자 정보가 없습니다.");e.displayName&&await (0,r.r7)(c,{displayName:e.displayName});let{updateDoc:o,doc:t}=await Promise.resolve().then(l.bind(l,5317)),{db:n}=await Promise.resolve().then(l.bind(l,6104)),a=t(n,"users",c.uid);await o(a,e),d(o=>o?{...o,...e}:null)}catch(e){throw e}},x=async e=>{try{if(!c)throw Error("사용자 정보가 없습니다.");console.log("\uD83D\uDD04 AuthContext updateEmailConsent 호출:",{사용자:c.uid,새로운_동의_상태:e}),await (0,s.ih)(c.uid,e),d(o=>o?{...o,emailConsent:!!e||null,consentDate:e?new Date:null}:null),console.log("✅ AuthContext updateEmailConsent 완료")}catch(e){throw console.error("❌ AuthContext updateEmailConsent 실패:",e),e}};return(0,t.jsx)(i.Provider,{value:{user:c,userProfile:g,loading:h,profileLoading:f,signIn:E,signUp:v,logout:b,resetPassword:_,updateUserProfile:j,updateEmailConsent:x,refreshUserProfile:U},children:o})}},347:()=>{},5776:e=>{e.exports={style:{fontFamily:"'Inter', 'Inter Fallback'",fontStyle:"normal"},className:"__className_472ac2",variable:"__variable_472ac2"}},9941:(e,o,l)=>{Promise.resolve().then(l.t.bind(l,5776,23)),Promise.resolve().then(l.t.bind(l,347,23)),Promise.resolve().then(l.bind(l,283))}},e=>{e.O(0,[842,135,965,670,86,441,964,358],()=>e(e.s=9941)),_N_E=e.O()}]);