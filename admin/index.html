<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>G-DEAL 관리자 패널</title>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #f5f5f5;
      min-height: 100vh;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .header h1 {
      font-size: 1.5rem;
    }
    .header-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .header-info .user-info {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    .header-buttons {
      display: flex;
      gap: 10px;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #4CAF50;
      color: white;
    }
    .btn-primary:hover {
      background: #45a049;
    }
    .btn-secondary {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
    }
    .btn-secondary:hover {
      background: rgba(255,255,255,0.3);
    }
    .btn-danger {
      background: #f44336;
      color: white;
    }
    .btn-danger:hover {
      background: #da190b;
    }
    .btn-small {
      padding: 6px 12px;
      font-size: 0.8rem;
    }
    .btn-approve {
      background: #10b981;
      color: white;
    }
    .btn-approve:hover {
      background: #059669;
    }
    .btn-to-learning {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }
    .btn-to-learning:hover {
      background: #bbf7d0;
    }
    .btn-to-sharing {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #bfdbfe;
    }
    .btn-to-sharing:hover {
      background: #bfdbfe;
    }
    .btn-to-operations {
      background: #f3e8ff;
      color: #6b21a8;
      border: 1px solid #e9d5ff;
    }
    .btn-to-operations:hover {
      background: #e9d5ff;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 50vh;
      font-size: 1.2rem;
      color: #666;
    }
    .access-denied {
      text-align: center;
      padding: 100px 20px;
    }
    .access-denied h2 {
      color: #f44336;
      margin-bottom: 20px;
    }
    .read-only-notice {
      background: #fef3c7;
      border: 1px solid #f59e0b;
      color: #92400e;
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }
    .tabs {
      display: flex;
      background: white;
      border-radius: 12px;
      padding: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      overflow-x: auto;
    }
    .tab {
      flex: 1;
      padding: 15px 20px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      color: #666;
      border-radius: 8px;
      transition: all 0.2s;
      white-space: nowrap;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .tab:hover {
      background: #f3f4f6;
    }
    .tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .tab .count {
      background: rgba(0,0,0,0.1);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
    }
    .tab.active .count {
      background: rgba(255,255,255,0.2);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .members-table {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .members-table table {
      width: 100%;
      border-collapse: collapse;
    }
    .members-table th, .members-table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    .members-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #333;
      font-size: 0.9rem;
    }
    .members-table tr:hover {
      background: #f8f9fa;
    }
    .members-table tr:last-child td {
      border-bottom: none;
    }
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .badge-superadmin {
      background: #7c3aed;
      color: white;
    }
    .badge-admin {
      background: #2563eb;
      color: white;
    }
    .badge-pending {
      background: #fbbf24;
      color: #333;
    }
    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .empty-state {
      text-align: center;
      padding: 50px;
      color: #666;
    }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #333;
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      display: none;
      z-index: 1001;
    }
    .toast.success {
      background: #10b981;
    }
    .toast.error {
      background: #ef4444;
    }
    .toast.active {
      display: block;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    .search-box {
      background: white;
      padding: 15px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .search-box input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.95rem;
    }
    .search-box input:focus {
      outline: none;
      border-color: #667eea;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    .modal-content h3 {
      margin-bottom: 15px;
      color: #333;
    }
    .modal-content p {
      margin-bottom: 25px;
      color: #666;
    }
    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
      }
      .header-info {
        flex-direction: column;
        gap: 10px;
      }
      .tabs {
        flex-wrap: nowrap;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .tab {
        min-width: 100px;
        flex: none;
      }
      .members-table {
        overflow-x: auto;
      }
      .members-table table {
        min-width: 600px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="loading" id="loading">
      로딩 중...
    </div>
  </div>

  <!-- 확인 모달 -->
  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <h3 id="confirmTitle">확인</h3>
      <p id="confirmMessage">진행하시겠습니까?</p>
      <div class="modal-buttons">
        <button class="btn btn-secondary" onclick="closeConfirmModal()">취소</button>
        <button class="btn btn-primary" id="confirmBtn" onclick="confirmAction()">확인</button>
      </div>
    </div>
  </div>

  <!-- 토스트 메시지 -->
  <div class="toast" id="toast"></div>

  <script>
    // Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyBJsqUJK1AjhrLNzIY_79dIR2Mlg7zD09w",
      authDomain: "gdeal-page-a67e2.firebaseapp.com",
      projectId: "gdeal-page-a67e2",
      storageBucket: "gdeal-page-a67e2.firebasestorage.app",
      messagingSenderId: "654155447220",
      appId: "1:654155447220:web:be9c45c91314842d0150e1"
    };

    // Firebase 초기화
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // 전역 변수
    let currentUser = null;
    let currentUserData = null;
    let allMembers = [];
    let canManage = false; // 운영사무국 또는 최고관리자인지
    let pendingAction = null;
    let currentTab = 'pending';
    let searchQuery = '';

    // 인증 상태 확인
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        await checkAdminAccess();
      } else {
        showAccessDenied('로그인이 필요합니다.');
      }
    });

    // 관리자 권한 확인
    async function checkAdminAccess() {
      try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        if (!userDoc.exists) {
          showAccessDenied('사용자 정보를 찾을 수 없습니다.');
          return;
        }

        currentUserData = userDoc.data();
        const role = currentUserData.role || '';
        const memberTier = currentUserData.memberTier || '';

        // 운영사무국(operations-office) 또는 최고관리자(superAdmin)만 접근 가능
        if (memberTier !== 'operations-office' && role !== 'superAdmin') {
          showAccessDenied('운영사무국 또는 최고 관리자만 접근할 수 있습니다.');
          return;
        }

        // 승인/등급 변경 권한: 운영사무국 또는 최고관리자
        canManage = (memberTier === 'operations-office' || role === 'superAdmin');

        // 관리자 페이지 렌더링
        renderAdminPage();
        loadMembers();
      } catch (error) {
        console.error('권한 확인 오류:', error);
        showAccessDenied('권한 확인 중 오류가 발생했습니다.');
      }
    }

    // 접근 거부 화면
    function showAccessDenied(message) {
      document.getElementById('app').innerHTML = `
        <div class="access-denied">
          <h2>접근 거부</h2>
          <p>${message}</p>
          <br>
          <a href="/" class="btn btn-primary">홈으로 돌아가기</a>
        </div>
      `;
    }

    // 관리자 페이지 렌더링
    function renderAdminPage() {
      const roleText = currentUserData.role === 'superAdmin' ? '최고 관리자' : '운영사무국';

      document.getElementById('app').innerHTML = `
        <div class="header">
          <h1>G-DEAL 관리자 패널</h1>
          <div class="header-info">
            <span class="user-info">${currentUserData.displayName || currentUserData.email} (${roleText})</span>
            <div class="header-buttons">
              <a href="/" class="btn btn-secondary">홈으로</a>
              <button class="btn btn-secondary" onclick="logout()">로그아웃</button>
            </div>
          </div>
        </div>
        <div class="container">
          <div class="tabs">
            <button class="tab active" data-tab="pending" onclick="switchTab('pending')">
              승인 대기 <span class="count" id="pendingCount">0</span>
            </button>
            <button class="tab" data-tab="learning" onclick="switchTab('learning')">
              배움회원 <span class="count" id="learningCount">0</span>
            </button>
            <button class="tab" data-tab="sharing" onclick="switchTab('sharing')">
              나눔회원 <span class="count" id="sharingCount">0</span>
            </button>
            <button class="tab" data-tab="operations" onclick="switchTab('operations')">
              운영사무국 <span class="count" id="operationsCount">0</span>
            </button>
          </div>

          <div class="search-box">
            <input type="text" id="searchInput" placeholder="이름 또는 이메일로 검색..." oninput="handleSearch(this.value)">
          </div>

          <!-- 승인 대기 탭 -->
          <div class="tab-content active" id="tab-pending">
            <div class="members-table">
              <table>
                <thead>
                  <tr>
                    <th>이름</th>
                    <th>이메일</th>
                    <th>가입일</th>
                    <th>작업</th>
                  </tr>
                </thead>
                <tbody id="pendingBody">
                  <tr><td colspan="4" class="empty-state">로딩 중...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- 배움회원 탭 -->
          <div class="tab-content" id="tab-learning">
            <div class="members-table">
              <table>
                <thead>
                  <tr>
                    <th>이름</th>
                    <th>이메일</th>
                    <th>등급 변경일</th>
                    <th>작업</th>
                  </tr>
                </thead>
                <tbody id="learningBody">
                  <tr><td colspan="4" class="empty-state">로딩 중...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- 나눔회원 탭 -->
          <div class="tab-content" id="tab-sharing">
            <div class="members-table">
              <table>
                <thead>
                  <tr>
                    <th>이름</th>
                    <th>이메일</th>
                    <th>등급 변경일</th>
                    <th>작업</th>
                  </tr>
                </thead>
                <tbody id="sharingBody">
                  <tr><td colspan="4" class="empty-state">로딩 중...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- 운영사무국 탭 -->
          <div class="tab-content" id="tab-operations">
            <div class="members-table">
              <table>
                <thead>
                  <tr>
                    <th>이름</th>
                    <th>이메일</th>
                    <th>역할</th>
                    <th>작업</th>
                  </tr>
                </thead>
                <tbody id="operationsBody">
                  <tr><td colspan="4" class="empty-state">로딩 중...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    // 탭 전환
    function switchTab(tabName) {
      currentTab = tabName;

      // 탭 버튼 활성화
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.tab === tabName) {
          tab.classList.add('active');
        }
      });

      // 탭 콘텐츠 활성화
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`tab-${tabName}`).classList.add('active');

      // 검색어 초기화
      document.getElementById('searchInput').value = '';
      searchQuery = '';

      renderCurrentTab();
    }

    // 검색 처리
    function handleSearch(query) {
      searchQuery = query.toLowerCase();
      renderCurrentTab();
    }

    // 회원 목록 로드
    async function loadMembers() {
      try {
        const snapshot = await db.collection('users').get();
        allMembers = [];

        snapshot.forEach(doc => {
          allMembers.push({
            id: doc.id,
            ...doc.data()
          });
        });

        updateCounts();
        renderCurrentTab();
      } catch (error) {
        console.error('회원 목록 로드 실패:', error);
        showToast('회원 목록을 불러오는데 실패했습니다.', 'error');
      }
    }

    // 카운트 업데이트
    function updateCounts() {
      const pending = allMembers.filter(m => m.status === 'pending' || !m.status);
      const learning = allMembers.filter(m => m.memberTier === 'learning-member' && m.status === 'approved');
      const sharing = allMembers.filter(m => m.memberTier === 'sharing-member' && m.status === 'approved');
      const operations = allMembers.filter(m => m.memberTier === 'operations-office' || m.role === 'superAdmin');

      document.getElementById('pendingCount').textContent = pending.length;
      document.getElementById('learningCount').textContent = learning.length;
      document.getElementById('sharingCount').textContent = sharing.length;
      document.getElementById('operationsCount').textContent = operations.length;
    }

    // 현재 탭 렌더링
    function renderCurrentTab() {
      switch(currentTab) {
        case 'pending':
          renderPendingTab();
          break;
        case 'learning':
          renderLearningTab();
          break;
        case 'sharing':
          renderSharingTab();
          break;
        case 'operations':
          renderOperationsTab();
          break;
      }
    }

    // 필터링 (검색)
    function filterMembers(members) {
      if (!searchQuery) return members;
      return members.filter(m => {
        const name = (m.name || '').toLowerCase();
        const email = (m.email || '').toLowerCase();
        return name.includes(searchQuery) || email.includes(searchQuery);
      });
    }

    // 날짜 포맷
    function formatDate(timestamp) {
      if (!timestamp) return '-';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      return date.toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
    }

    // 승인 대기 탭 렌더링
    function renderPendingTab() {
      const members = filterMembers(
        allMembers.filter(m => m.status === 'pending' || !m.status)
      ).sort((a, b) => {
        const dateA = a.createdAt?.toDate?.() || new Date(0);
        const dateB = b.createdAt?.toDate?.() || new Date(0);
        return dateB - dateA;
      });

      const tbody = document.getElementById('pendingBody');

      if (members.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-state">승인 대기 중인 회원이 없습니다.</td></tr>';
        return;
      }

      tbody.innerHTML = members.map(member => `
        <tr>
          <td>${member.displayName || '-'}</td>
          <td>${member.email || '-'}</td>
          <td>${formatDate(member.createdAt)}</td>
          <td class="actions">
            ${canManage ? `
              <button class="btn btn-approve btn-small" onclick="showConfirm('approve', '${member.id}', '${member.displayName || member.email}')">
                승인 (배움회원)
              </button>
              <button class="btn btn-danger btn-small" onclick="showConfirm('reject', '${member.id}', '${member.displayName || member.email}')">
                거부
              </button>
            ` : '<span style="color:#999">권한 없음</span>'}
          </td>
        </tr>
      `).join('');
    }

    // 배움회원 탭 렌더링
    function renderLearningTab() {
      const members = filterMembers(
        allMembers.filter(m => m.memberTier === 'learning-member' && m.status === 'approved')
      ).sort((a, b) => {
        const dateA = a.tierChangedAt?.toDate?.() || a.createdAt?.toDate?.() || new Date(0);
        const dateB = b.tierChangedAt?.toDate?.() || b.createdAt?.toDate?.() || new Date(0);
        return dateB - dateA;
      });

      const tbody = document.getElementById('learningBody');

      if (members.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-state">배움회원이 없습니다.</td></tr>';
        return;
      }

      tbody.innerHTML = members.map(member => `
        <tr>
          <td>${member.displayName || '-'}</td>
          <td>${member.email || '-'}</td>
          <td>${formatDate(member.tierChangedAt || member.createdAt)}</td>
          <td class="actions">
            ${canManage ? `
              <button class="btn btn-to-sharing btn-small" onclick="showConfirm('toSharing', '${member.id}', '${member.displayName || member.email}')">
                나눔회원으로
              </button>
            ` : '<span style="color:#999">권한 없음</span>'}
          </td>
        </tr>
      `).join('');
    }

    // 나눔회원 탭 렌더링
    function renderSharingTab() {
      const members = filterMembers(
        allMembers.filter(m => m.memberTier === 'sharing-member' && m.status === 'approved')
      ).sort((a, b) => {
        const dateA = a.tierChangedAt?.toDate?.() || a.createdAt?.toDate?.() || new Date(0);
        const dateB = b.tierChangedAt?.toDate?.() || b.createdAt?.toDate?.() || new Date(0);
        return dateB - dateA;
      });

      const tbody = document.getElementById('sharingBody');

      if (members.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-state">나눔회원이 없습니다.</td></tr>';
        return;
      }

      tbody.innerHTML = members.map(member => `
        <tr>
          <td>${member.displayName || '-'}</td>
          <td>${member.email || '-'}</td>
          <td>${formatDate(member.tierChangedAt || member.createdAt)}</td>
          <td class="actions">
            ${canManage ? `
              <button class="btn btn-to-learning btn-small" onclick="showConfirm('toLearning', '${member.id}', '${member.displayName || member.email}')">
                배움회원으로
              </button>
              <button class="btn btn-to-operations btn-small" onclick="showConfirm('toOperations', '${member.id}', '${member.displayName || member.email}')">
                운영사무국으로
              </button>
            ` : '<span style="color:#999">권한 없음</span>'}
          </td>
        </tr>
      `).join('');
    }

    // 운영사무국 탭 렌더링
    function renderOperationsTab() {
      const members = filterMembers(
        allMembers.filter(m => m.memberTier === 'operations-office' || m.role === 'superAdmin')
      ).sort((a, b) => {
        // 최고관리자 먼저
        if (a.role === 'superAdmin' && b.role !== 'superAdmin') return -1;
        if (b.role === 'superAdmin' && a.role !== 'superAdmin') return 1;
        const dateA = a.tierChangedAt?.toDate?.() || a.createdAt?.toDate?.() || new Date(0);
        const dateB = b.tierChangedAt?.toDate?.() || b.createdAt?.toDate?.() || new Date(0);
        return dateB - dateA;
      });

      const tbody = document.getElementById('operationsBody');

      if (members.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-state">운영사무국 멤버가 없습니다.</td></tr>';
        return;
      }

      tbody.innerHTML = members.map(member => {
        const isSuperAdmin = member.role === 'superAdmin';
        const roleBadge = isSuperAdmin
          ? '<span class="badge badge-superadmin">최고 관리자</span>'
          : '<span class="badge badge-admin">운영사무국</span>';

        return `
          <tr>
            <td>${member.displayName || '-'}</td>
            <td>${member.email || '-'}</td>
            <td>${roleBadge}</td>
            <td class="actions">
              ${canManage && !isSuperAdmin ? `
                <button class="btn btn-to-sharing btn-small" onclick="showConfirm('toSharingFromOps', '${member.id}', '${member.displayName || member.email}')">
                  나눔회원으로
                </button>
              ` : isSuperAdmin ? '<span style="color:#999">변경 불가</span>' : '<span style="color:#999">권한 없음</span>'}
            </td>
          </tr>
        `;
      }).join('');
    }

    // 확인 모달 표시
    function showConfirm(action, userId, userName) {
      pendingAction = { action, userId, userName };

      const titles = {
        'approve': '회원 승인',
        'reject': '회원 거부',
        'toSharing': '나눔회원으로 변경',
        'toLearning': '배움회원으로 변경',
        'toOperations': '운영사무국으로 변경',
        'toSharingFromOps': '나눔회원으로 변경'
      };

      const messages = {
        'approve': `<strong>${userName}</strong>님을 승인하고 배움회원으로 등록하시겠습니까?`,
        'reject': `<strong>${userName}</strong>님의 가입을 거부하시겠습니까?`,
        'toSharing': `<strong>${userName}</strong>님을 나눔회원으로 변경하시겠습니까?`,
        'toLearning': `<strong>${userName}</strong>님을 배움회원으로 변경하시겠습니까?`,
        'toOperations': `<strong>${userName}</strong>님을 운영사무국으로 변경하시겠습니까?`,
        'toSharingFromOps': `<strong>${userName}</strong>님을 나눔회원으로 변경하시겠습니까?`
      };

      document.getElementById('confirmTitle').textContent = titles[action];
      document.getElementById('confirmMessage').innerHTML = messages[action];
      document.getElementById('confirmModal').classList.add('active');
    }

    // 확인 모달 닫기
    function closeConfirmModal() {
      document.getElementById('confirmModal').classList.remove('active');
      pendingAction = null;
    }

    // 액션 실행
    async function confirmAction() {
      if (!pendingAction) return;

      const { action, userId } = pendingAction;
      closeConfirmModal();

      try {
        let updateData = {
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        switch(action) {
          case 'approve':
            updateData.status = 'approved';
            updateData.memberTier = 'learning-member';
            updateData.tierChangedAt = firebase.firestore.FieldValue.serverTimestamp();
            break;
          case 'reject':
            updateData.status = 'rejected';
            break;
          case 'toSharing':
            updateData.memberTier = 'sharing-member';
            updateData.tierChangedAt = firebase.firestore.FieldValue.serverTimestamp();
            break;
          case 'toLearning':
            updateData.memberTier = 'learning-member';
            updateData.tierChangedAt = firebase.firestore.FieldValue.serverTimestamp();
            break;
          case 'toOperations':
            updateData.memberTier = 'operations-office';
            updateData.tierChangedAt = firebase.firestore.FieldValue.serverTimestamp();
            break;
          case 'toSharingFromOps':
            updateData.memberTier = 'sharing-member';
            updateData.tierChangedAt = firebase.firestore.FieldValue.serverTimestamp();
            break;
        }

        await db.collection('users').doc(userId).update(updateData);

        const successMessages = {
          'approve': '회원이 승인되어 배움회원으로 등록되었습니다.',
          'reject': '회원 가입이 거부되었습니다.',
          'toSharing': '나눔회원으로 변경되었습니다.',
          'toLearning': '배움회원으로 변경되었습니다.',
          'toOperations': '운영사무국으로 변경되었습니다.',
          'toSharingFromOps': '나눔회원으로 변경되었습니다.'
        };

        showToast(successMessages[action], 'success');
        loadMembers();
      } catch (error) {
        console.error('작업 실패:', error);
        showToast('작업에 실패했습니다.', 'error');
      }
    }

    // 로그아웃
    function logout() {
      auth.signOut().then(() => {
        window.location.href = '/';
      });
    }

    // 토스트 메시지
    function showToast(message, type = '') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast active ' + type;

      setTimeout(() => {
        toast.classList.remove('active');
      }, 3000);
    }

    // 모달 외부 클릭 시 닫기
    document.getElementById('confirmModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('confirmModal')) {
        closeConfirmModal();
      }
    });
  </script>
</body>
</html>
