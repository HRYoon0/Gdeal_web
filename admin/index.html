<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>G-DEAL 관리자 패널</title>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #f5f5f5;
      min-height: 100vh;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .header h1 {
      font-size: 1.5rem;
    }
    .header-buttons {
      display: flex;
      gap: 10px;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #4CAF50;
      color: white;
    }
    .btn-primary:hover {
      background: #45a049;
    }
    .btn-secondary {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
    }
    .btn-secondary:hover {
      background: rgba(255,255,255,0.3);
    }
    .btn-danger {
      background: #f44336;
      color: white;
    }
    .btn-danger:hover {
      background: #da190b;
    }
    .btn-small {
      padding: 6px 12px;
      font-size: 0.8rem;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 50vh;
      font-size: 1.2rem;
      color: #666;
    }
    .access-denied {
      text-align: center;
      padding: 100px 20px;
    }
    .access-denied h2 {
      color: #f44336;
      margin-bottom: 20px;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .stat-card h3 {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 10px;
    }
    .stat-card .value {
      font-size: 2rem;
      font-weight: bold;
      color: #333;
    }
    .filters {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .filters h3 {
      margin-bottom: 15px;
      color: #333;
    }
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .filter-group label {
      font-size: 0.85rem;
      color: #666;
    }
    .filter-group select, .filter-group input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
      min-width: 150px;
    }
    .members-table {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .members-table table {
      width: 100%;
      border-collapse: collapse;
    }
    .members-table th, .members-table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    .members-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #333;
      font-size: 0.9rem;
    }
    .members-table tr:hover {
      background: #f8f9fa;
    }
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .badge-superadmin {
      background: #7c3aed;
      color: white;
    }
    .badge-admin {
      background: #2563eb;
      color: white;
    }
    .badge-operations {
      background: #059669;
      color: white;
    }
    .badge-sharing {
      background: #d97706;
      color: white;
    }
    .badge-learning {
      background: #0891b2;
      color: white;
    }
    .badge-general {
      background: #6b7280;
      color: white;
    }
    .badge-pending {
      background: #fbbf24;
      color: #333;
    }
    .badge-approved {
      background: #10b981;
      color: white;
    }
    .badge-rejected {
      background: #ef4444;
      color: white;
    }
    .actions {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-content h2 {
      margin-bottom: 20px;
      color: #333;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }
    .form-group select, .form-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }
    .form-group p {
      margin-top: 5px;
      font-size: 0.85rem;
      color: #666;
    }
    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #333;
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      display: none;
      z-index: 1001;
    }
    .toast.success {
      background: #10b981;
    }
    .toast.error {
      background: #ef4444;
    }
    .toast.active {
      display: block;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    .empty-state {
      text-align: center;
      padding: 50px;
      color: #666;
    }
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
      }
      .members-table {
        overflow-x: auto;
      }
      .members-table table {
        min-width: 800px;
      }
      .filter-row {
        flex-direction: column;
        align-items: stretch;
      }
      .filter-group select, .filter-group input {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="loading" id="loading">
      로딩 중...
    </div>
  </div>

  <!-- 회원 편집 모달 -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <h2>회원 정보 수정</h2>
      <form id="editForm">
        <input type="hidden" id="editUserId">
        <div class="form-group">
          <label>이메일</label>
          <input type="text" id="editEmail" disabled>
        </div>
        <div class="form-group">
          <label>이름</label>
          <input type="text" id="editName" disabled>
        </div>
        <div class="form-group">
          <label>회원 등급 (memberTier)</label>
          <select id="editMemberTier">
            <option value="">일반회원</option>
            <option value="learning-member">배움회원</option>
            <option value="sharing-member">나눔회원</option>
            <option value="operations-office">운영사무국</option>
          </select>
          <p>회원 등급을 변경합니다.</p>
        </div>
        <div class="form-group">
          <label>역할 (role)</label>
          <select id="editRole">
            <option value="">일반</option>
            <option value="admin">관리자</option>
            <option value="superAdmin">최고 관리자</option>
          </select>
          <p>관리자 권한을 부여합니다.</p>
        </div>
        <div class="form-group">
          <label>상태 (status)</label>
          <select id="editStatus">
            <option value="pending">대기중</option>
            <option value="approved">승인됨</option>
            <option value="rejected">거부됨</option>
          </select>
          <p>회원 가입 승인 상태를 변경합니다.</p>
        </div>
        <div class="modal-buttons">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">취소</button>
          <button type="submit" class="btn btn-primary">저장</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 토스트 메시지 -->
  <div class="toast" id="toast"></div>

  <script>
    // Firebase 설정 (메인 앱과 동일한 설정)
    const firebaseConfig = {
      apiKey: "AIzaSyBJsqUJK1AjhrLNzIY_79dIR2Mlg7zD09w",
      authDomain: "gdeal-page-a67e2.firebaseapp.com",
      projectId: "gdeal-page-a67e2",
      storageBucket: "gdeal-page-a67e2.firebasestorage.app",
      messagingSenderId: "654155447220",
      appId: "1:654155447220:web:be9c45c91314842d0150e1"
    };

    // Firebase 초기화
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // 전역 변수
    let currentUser = null;
    let currentUserData = null;
    let allMembers = [];

    // 회원 등급 라벨
    const tierLabels = {
      '': '일반회원',
      'learning-member': '배움회원',
      'sharing-member': '나눔회원',
      'operations-office': '운영사무국'
    };

    // 역할 라벨
    const roleLabels = {
      '': '일반',
      'admin': '관리자',
      'superAdmin': '최고 관리자'
    };

    // 상태 라벨
    const statusLabels = {
      'pending': '대기중',
      'approved': '승인됨',
      'rejected': '거부됨'
    };

    // 인증 상태 확인
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        await checkAdminAccess();
      } else {
        showAccessDenied('로그인이 필요합니다.');
      }
    });

    // 관리자 권한 확인
    async function checkAdminAccess() {
      try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        if (!userDoc.exists) {
          showAccessDenied('사용자 정보를 찾을 수 없습니다.');
          return;
        }

        currentUserData = userDoc.data();
        const role = currentUserData.role || '';

        if (role !== 'superAdmin' && role !== 'admin') {
          showAccessDenied('관리자 권한이 필요합니다.');
          return;
        }

        // 관리자 페이지 렌더링
        renderAdminPage();
        loadMembers();
      } catch (error) {
        console.error('권한 확인 오류:', error);
        showAccessDenied('권한 확인 중 오류가 발생했습니다.');
      }
    }

    // 접근 거부 화면
    function showAccessDenied(message) {
      document.getElementById('app').innerHTML = `
        <div class="access-denied">
          <h2>접근 거부</h2>
          <p>${message}</p>
          <br>
          <a href="/" class="btn btn-primary">홈으로 돌아가기</a>
        </div>
      `;
    }

    // 관리자 페이지 렌더링
    function renderAdminPage() {
      document.getElementById('app').innerHTML = `
        <div class="header">
          <h1>G-DEAL 관리자 패널</h1>
          <div class="header-buttons">
            <a href="/" class="btn btn-secondary">홈으로</a>
            <button class="btn btn-secondary" onclick="logout()">로그아웃</button>
          </div>
        </div>
        <div class="container">
          <div class="stats" id="stats">
            <div class="stat-card">
              <h3>전체 회원</h3>
              <div class="value" id="totalCount">-</div>
            </div>
            <div class="stat-card">
              <h3>승인 대기</h3>
              <div class="value" id="pendingCount">-</div>
            </div>
            <div class="stat-card">
              <h3>나눔회원</h3>
              <div class="value" id="sharingCount">-</div>
            </div>
            <div class="stat-card">
              <h3>배움회원</h3>
              <div class="value" id="learningCount">-</div>
            </div>
          </div>

          <div class="filters">
            <h3>필터</h3>
            <div class="filter-row">
              <div class="filter-group">
                <label>회원 등급</label>
                <select id="filterTier" onchange="applyFilters()">
                  <option value="">전체</option>
                  <option value="none">일반회원</option>
                  <option value="learning-member">배움회원</option>
                  <option value="sharing-member">나눔회원</option>
                  <option value="operations-office">운영사무국</option>
                </select>
              </div>
              <div class="filter-group">
                <label>상태</label>
                <select id="filterStatus" onchange="applyFilters()">
                  <option value="">전체</option>
                  <option value="pending">대기중</option>
                  <option value="approved">승인됨</option>
                  <option value="rejected">거부됨</option>
                </select>
              </div>
              <div class="filter-group">
                <label>역할</label>
                <select id="filterRole" onchange="applyFilters()">
                  <option value="">전체</option>
                  <option value="none">일반</option>
                  <option value="admin">관리자</option>
                  <option value="superAdmin">최고 관리자</option>
                </select>
              </div>
              <div class="filter-group">
                <label>검색</label>
                <input type="text" id="filterSearch" placeholder="이름 또는 이메일" oninput="applyFilters()">
              </div>
            </div>
          </div>

          <div class="members-table">
            <table>
              <thead>
                <tr>
                  <th>이름</th>
                  <th>이메일</th>
                  <th>회원 등급</th>
                  <th>역할</th>
                  <th>상태</th>
                  <th>가입일</th>
                  <th>작업</th>
                </tr>
              </thead>
              <tbody id="membersBody">
                <tr>
                  <td colspan="7" class="empty-state">로딩 중...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    // 회원 목록 로드
    async function loadMembers() {
      try {
        const snapshot = await db.collection('users').orderBy('createdAt', 'desc').get();
        allMembers = [];

        snapshot.forEach(doc => {
          allMembers.push({
            id: doc.id,
            ...doc.data()
          });
        });

        updateStats();
        applyFilters();
      } catch (error) {
        console.error('회원 목록 로드 실패:', error);
        showToast('회원 목록을 불러오는데 실패했습니다.', 'error');
      }
    }

    // 통계 업데이트
    function updateStats() {
      document.getElementById('totalCount').textContent = allMembers.length;
      document.getElementById('pendingCount').textContent = allMembers.filter(m => m.status === 'pending').length;
      document.getElementById('sharingCount').textContent = allMembers.filter(m => m.memberTier === 'sharing-member').length;
      document.getElementById('learningCount').textContent = allMembers.filter(m => m.memberTier === 'learning-member').length;
    }

    // 필터 적용
    function applyFilters() {
      const tierFilter = document.getElementById('filterTier').value;
      const statusFilter = document.getElementById('filterStatus').value;
      const roleFilter = document.getElementById('filterRole').value;
      const searchFilter = document.getElementById('filterSearch').value.toLowerCase();

      let filtered = allMembers.filter(member => {
        // 등급 필터
        if (tierFilter) {
          if (tierFilter === 'none' && member.memberTier) return false;
          if (tierFilter !== 'none' && member.memberTier !== tierFilter) return false;
        }

        // 상태 필터
        if (statusFilter && member.status !== statusFilter) return false;

        // 역할 필터
        if (roleFilter) {
          if (roleFilter === 'none' && member.role) return false;
          if (roleFilter !== 'none' && member.role !== roleFilter) return false;
        }

        // 검색 필터
        if (searchFilter) {
          const name = (member.name || '').toLowerCase();
          const email = (member.email || '').toLowerCase();
          if (!name.includes(searchFilter) && !email.includes(searchFilter)) return false;
        }

        return true;
      });

      renderMembers(filtered);
    }

    // 회원 목록 렌더링
    function renderMembers(members) {
      const tbody = document.getElementById('membersBody');

      if (members.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state">회원이 없습니다.</td></tr>';
        return;
      }

      tbody.innerHTML = members.map(member => {
        const tierBadge = getTierBadge(member.memberTier);
        const roleBadge = getRoleBadge(member.role);
        const statusBadge = getStatusBadge(member.status);
        const createdAt = member.createdAt ? formatDate(member.createdAt.toDate()) : '-';

        return `
          <tr>
            <td>${member.name || '-'}</td>
            <td>${member.email || '-'}</td>
            <td>${tierBadge}</td>
            <td>${roleBadge}</td>
            <td>${statusBadge}</td>
            <td>${createdAt}</td>
            <td class="actions">
              <button class="btn btn-primary btn-small" onclick="openEditModal('${member.id}')">수정</button>
              ${member.status === 'pending' ? `
                <button class="btn btn-small" style="background:#10b981;color:white" onclick="quickApprove('${member.id}')">승인</button>
                <button class="btn btn-danger btn-small" onclick="quickReject('${member.id}')">거부</button>
              ` : ''}
            </td>
          </tr>
        `;
      }).join('');
    }

    // 등급 배지
    function getTierBadge(tier) {
      const badges = {
        'operations-office': '<span class="badge badge-operations">운영사무국</span>',
        'sharing-member': '<span class="badge badge-sharing">나눔회원</span>',
        'learning-member': '<span class="badge badge-learning">배움회원</span>'
      };
      return badges[tier] || '<span class="badge badge-general">일반회원</span>';
    }

    // 역할 배지
    function getRoleBadge(role) {
      const badges = {
        'superAdmin': '<span class="badge badge-superadmin">최고 관리자</span>',
        'admin': '<span class="badge badge-admin">관리자</span>'
      };
      return badges[role] || '<span class="badge badge-general">일반</span>';
    }

    // 상태 배지
    function getStatusBadge(status) {
      const badges = {
        'pending': '<span class="badge badge-pending">대기중</span>',
        'approved': '<span class="badge badge-approved">승인됨</span>',
        'rejected': '<span class="badge badge-rejected">거부됨</span>'
      };
      return badges[status] || '<span class="badge badge-general">-</span>';
    }

    // 날짜 포맷
    function formatDate(date) {
      return date.toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
    }

    // 수정 모달 열기
    function openEditModal(userId) {
      const member = allMembers.find(m => m.id === userId);
      if (!member) return;

      document.getElementById('editUserId').value = userId;
      document.getElementById('editEmail').value = member.email || '';
      document.getElementById('editName').value = member.name || '';
      document.getElementById('editMemberTier').value = member.memberTier || '';
      document.getElementById('editRole').value = member.role || '';
      document.getElementById('editStatus').value = member.status || 'pending';

      document.getElementById('editModal').classList.add('active');
    }

    // 모달 닫기
    function closeModal() {
      document.getElementById('editModal').classList.remove('active');
    }

    // 수정 폼 제출
    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const userId = document.getElementById('editUserId').value;
      const memberTier = document.getElementById('editMemberTier').value;
      const role = document.getElementById('editRole').value;
      const status = document.getElementById('editStatus').value;

      try {
        const updateData = {
          status: status,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        // memberTier 처리 (빈 값이면 필드 삭제)
        if (memberTier) {
          updateData.memberTier = memberTier;
          updateData.tierChangedAt = firebase.firestore.FieldValue.serverTimestamp();
        } else {
          updateData.memberTier = firebase.firestore.FieldValue.delete();
        }

        // role 처리 (빈 값이면 필드 삭제)
        if (role) {
          updateData.role = role;
        } else {
          updateData.role = firebase.firestore.FieldValue.delete();
        }

        await db.collection('users').doc(userId).update(updateData);

        showToast('회원 정보가 수정되었습니다.', 'success');
        closeModal();
        loadMembers();
      } catch (error) {
        console.error('회원 정보 수정 실패:', error);
        showToast('회원 정보 수정에 실패했습니다.', 'error');
      }
    });

    // 빠른 승인
    async function quickApprove(userId) {
      if (!confirm('이 회원을 승인하시겠습니까?')) return;

      try {
        await db.collection('users').doc(userId).update({
          status: 'approved',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast('회원이 승인되었습니다.', 'success');
        loadMembers();
      } catch (error) {
        console.error('승인 실패:', error);
        showToast('승인에 실패했습니다.', 'error');
      }
    }

    // 빠른 거부
    async function quickReject(userId) {
      if (!confirm('이 회원을 거부하시겠습니까?')) return;

      try {
        await db.collection('users').doc(userId).update({
          status: 'rejected',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast('회원이 거부되었습니다.', 'success');
        loadMembers();
      } catch (error) {
        console.error('거부 실패:', error);
        showToast('거부에 실패했습니다.', 'error');
      }
    }

    // 로그아웃
    function logout() {
      auth.signOut().then(() => {
        window.location.href = '/';
      });
    }

    // 토스트 메시지
    function showToast(message, type = '') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast active ' + type;

      setTimeout(() => {
        toast.classList.remove('active');
      }, 3000);
    }

    // 모달 외부 클릭 시 닫기
    document.getElementById('editModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('editModal')) {
        closeModal();
      }
    });
  </script>
</body>
</html>
